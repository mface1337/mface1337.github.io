<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self'; connect-src 'self' https://formspree.io; form-action 'self' https://formspree.io;">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>Contact - Chris Meck</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="matrix-rain">
        <span style="--i:1;">10 01 10</span>
        <span style="--i:2;">01 10 01</span>
        <span style="--i:3;">11 00 11</span>
        <span style="--i:4;">01 01 01</span>
        <span style="--i:5;">10 01 10</span>
        <span style="--i:6;">11 10 00</span>
        <span style="--i:7;">00 01 11</span>
        <span style="--i:8;">10 10 10</span>
        <span style="--i:9;">01 10 01</span>
        <span style="--i:10;">11 00 11</span>
        <span style="--i:11;">10 11 00</span>
        <span style="--i:12;">01 01 10</span>
        <span style="--i:13;">11 10 01</span>
        <span style="--i:14;">00 11 00</span>
        <span style="--i:15;">10 01 11</span>
        <span style="--i:16;">01 10 00</span>
        <span style="--i:17;">11 00 10</span>
        <span style="--i:18;">10 11 01</span>
        <span style="--i:19;">01 01 11</span>
        <span style="--i:20;">00 10 01</span>
    </div>
    <header>
        <nav>
            <span class="prompt">user@portfolio:~$ </span>
            <a href="index.html">home</a>
            <a href="about.html">about</a>
            <a href="projects.html">projects</a>
            <a href="certificates.html">certificates</a>
            <a href="contact.html">contact</a>
        </nav>
    </header>
    <main>
        <div class="terminal-window">
            <div class="title-bar">Contact Information</div>
            <div class="terminal-content">
                <p>$ contact_info</p>
                <ul>
                    <li>Email: <span id="email-display"></span></li>
                    <li>LinkedIn: <a href="https://www.linkedin.com/in/cm1337" target="_blank" rel="noopener noreferrer">https://www.linkedin.com/in/cm1337</a></li>
                </ul>
            </div>
        </div>
        <div class="terminal-window">
            <div class="title-bar">Kali Terminal - Send Encrypted Message</div>
            <div class="terminal-content kali-terminal" id="kali-terminal">
                <div class="terminal-buffer" id="terminal-buffer">
                    <p>kali@kali:~$ Initializing secure channel...</p>
                    <p>kali@kali:~$ Authentication: SUCCESS</p>
                    <p>kali@kali:~$ Enter your email ></p>
                </div>
                <div class="terminal-input">
                    <span class="prompt">kali@kali:~$ </span>
                    <input type="text" id="terminal-input" autofocus>
                    <span class="blink-cursor">█</span>
                </div>
            </div>
        </div>
    </main>
    <footer>
        <p>© 2023 Chris Meck. All rights reserved.</p>
    </footer>
    <script>
        // Obfuscate email display
        document.getElementById('email-display').textContent = 'mecktech@gmail.com';

        const terminalBuffer = document.getElementById('terminal-buffer');
        const terminalInput = document.getElementById('terminal-input');
        const kaliTerminal = document.getElementById('kali-terminal');
        let step = 1; // 1: email, 2: message, 3: confirm
        let userEmail = '';
        let userMessage = '';
        let lastSubmissionTime = 0;
        const RATE_LIMIT_MS = 30000; // 30 seconds

        // Sanitization and validation functions
        function sanitizeInput(input) {
            // Remove HTML tags, scripts, and dangerous characters
            return input.replace(/[<>{}]/g, '') // Remove HTML-like characters
                       .replace(/(\r\n|\n|\r)/gm, ' ') // Replace newlines with spaces
                       .replace(/\s+/g, ' ').trim(); // Normalize spaces
        }

        function validateEmail(email) {
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            return emailRegex.test(email);
        }

        function appendToBuffer(text) {
            const p = document.createElement('p');
            p.textContent = text;
            terminalBuffer.appendChild(p);
            kaliTerminal.scrollTop = kaliTerminal.scrollHeight;
        }

        terminalInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                const inputValue = terminalInput.value.trim();
                if (inputValue === '') return;

                const sanitizedInput = sanitizeInput(inputValue);
                if (sanitizedInput.length > 500) {
                    appendToBuffer('kali@kali:~$ Error: Input too long (max 500 characters).');
                    return;
                }

                if (step === 1) {
                    // Step 1: Collect email
                    if (!validateEmail(sanitizedInput)) {
                        appendToBuffer('kali@kali:~$ Error: Invalid email format.');
                        appendToBuffer('kali@kali:~$ Enter your email >');
                        terminalInput.value = '';
                        return;
                    }
                    userEmail = sanitizedInput;
                    appendToBuffer(`kali@kali:~$ Enter your email > ${userEmail}`);
                    appendToBuffer('kali@kali:~$ Enter your message >');
                    step = 2;
                } else if (step === 2) {
                    // Step 2: Collect message
                    userMessage = sanitizedInput;
                    appendToBuffer(`kali@kali:~$ Enter your message > ${userMessage}`);
                    appendToBuffer('kali@kali:~$ Send message? [y/n] >');
                    step = 3;
                } else if (step === 3) {
                    // Step 3: Confirm and send
                    appendToBuffer(`kali@kali:~$ Send message? [y/n] > ${sanitizedInput}`);
                    if (sanitizedInput.toLowerCase() === 'y') {
                        appendToBuffer('kali@kali:~$ Sending encrypted payload...');
                        sendEmail();
                    } else {
                        appendToBuffer('kali@kali:~$ Transmission aborted.');
                        appendToBuffer('kali@kali:~$ Enter your email >');
                        step = 1;
                    }
                }
                terminalInput.value = '';
            }
        });

        function sendEmail() {
            const now = Date.now();
            if (now - lastSubmissionTime < RATE_LIMIT_MS) {
                const remainingSeconds = Math.ceil((RATE_LIMIT_MS - (now - lastSubmissionTime)) / 1000);
                appendToBuffer(`kali@kali:~$ Error: Rate limit exceeded. Try again in ${remainingSeconds} seconds.`);
                appendToBuffer('kali@kali:~$ Enter your email >');
                step = 1;
                return;
            }

            const formData = new FormData();
            formData.append('email', 'mecktech@gmail.com'); // Recipient
            formData.append('sender', userEmail); // Sender's email
            formData.append('message', userMessage); // Message

            fetch('https://formspree.io/f/mzzezbzl', {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    lastSubmissionTime = Date.now(); // Update last submission time
                    appendToBuffer('kali@kali:~$ Payload delivered successfully!');
                    appendToBuffer('kali@kali:~$ Enter your email >');
                    step = 1;
                } else {
                    appendToBuffer('kali@kali:~$ Error: Transmission failed. Retry?');
                    appendToBuffer('kali@kali:~$ Enter your email >');
                    step = 1;
                }
            })
            .catch(error => {
                appendToBuffer(`kali@kali:~$ Error: ${error.message}`);
                appendToBuffer('kali@kali:~$ Enter your email >');
                step = 1;
                console.error('Formspree Error:', error);
            });
        }

        // Easter egg: Hidden command
        document.addEventListener('keydown', (event) => {
            if (event.key === 'w' && event.ctrlKey) {
                appendToBuffer('kali@kali:~$ whoami');
                appendToBuffer('kali@kali:~$ Identity: EliteHacker1337');
            }
        });

        // Ensure expandable images work (if any)
        document.querySelectorAll('.expandable').forEach(img => {
            img.addEventListener('click', () => {
                img.classList.toggle('expanded');
            });
        });
    </script>
</body>
</html>